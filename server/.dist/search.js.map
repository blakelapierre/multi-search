{"version":3,"sources":["search.ts"],"names":[],"mappings":"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","file":"search.js","sourcesContent":["const puppeteer = require('puppeteer');\n\nimport engines from './engines';\n\nconst document: any = {};\n\nclass PagePool {\n  size = engines.length * 2\n\n  freePages = []\n\n  reservations = []\n\n  totalPages = 0\n\n  browserPromise\n\n  constructor(browserPromise) {\n    this.browserPromise = browserPromise;\n  }\n\n  async getPage() {\n    const browser = await this.browserPromise;\n\n    let page = this.freePages.pop();\n\n    if (page === undefined) {\n      if (this.totalPages < this.size) {\n        this.totalPages++;\n        page = await browser.newPage();\n      }\n      else {\n        page = await this.waitForPage();\n      }\n    }\n\n    return {\n      page,\n      // release() { return (next = this.reservations.pop()) ? this.freePages.push(page) : next(page); }\n      release: (page => {\n        const next = this.reservations.pop();\n\n        if (next === undefined)\n          this.freePages.push(page);\n        else\n          next(page);\n\n      }).bind(this, page)\n    };\n  }\n\n  waitForPage() {\n    return new Promise((resolve, reject) => this.reservations.push(resolve));\n  }\n}\n\nconst pagePool = new PagePool(puppeteer.launch());\n\nexport default async (query = 'test', partialResults) => {\n  const [start, results, end] = await asyncBenchmark(() => Promise.all(search(query, pagePool, partialResults))),\n                         urls = (results || [])\n                                  .reduce(\n                                    (urls, {name, results}, i) =>\n                                      (results || []).reduce((urls, {url}, i) => {\n                                        (urls[url] = urls[url] || []).push([name, i]);\n                                        return urls;\n                                      }, urls), {});\n\n  return {query, urls, results, start, end};\n};\n\nfunction search(query, pagePool, partialResults) {\n  return engines.map(async ({name, queryUrl, evaluator, cache}) => {\n    const cachedValue = cache.retrieve(query);\n\n    if (cachedValue && (cachedValue.start + 60 * 1000) >= new Date().getTime()) {\n      partialResults(cachedValue);\n\n      return cachedValue;\n    }\n\n    const {page, release} = await pagePool.getPage();\n\n    try {\n      const [start, _, end] = await asyncBenchmark(() => page.goto(`${queryUrl}${encodeURI(query)}`));\n      try {\n        const results = await page.evaluate(evaluator);\n\nif (name === 'Bing') console.log({results});\n\n        const returnValue = {name, results, start, end};\n\n        partialResults(returnValue);\n\n        cache.put(query, returnValue);\n\n        release();\n        return returnValue;\n      } catch(e) {console.error(e);}\n    } catch(e) {console.error(e);}\n\n    release();\n  });\n}\n\nconst asyncBenchmark = async fn => [new Date().getTime(), await fn(), new Date().getTime()];\n\nconst groupBy =\n  (list, selector, transform = a => a, groups = {}) =>\n    list.reduce((groups, item) => {\n      const value = selector(item);\n      pushTo(groups, value, transform(value));\n      // push((groups[value] = groups[value] || []), transform(item));\n      // (groups[value] = groups[value] || []).push(transform(item));\n      return groups;\n    });\n\nfunction pushTo(obj, key, item) {\n  const stack = (obj[key] = obj[key] || []);\n\n  stack.push(item);\n\n  return stack;\n}\n\n// function groupBy(list, property) {\n//   return list.reduce((groups, item) => {\n//     const value = selector(item);\n//     (groups[value] = groups[value] || []).push(transform(item))\n//   });\n//   return list.reduce((groups, item) => {\n//     (groups[property] = groups[property] || []).push(item);\n//     return groups;\n//   }, {});\n// }"]}