{"version":3,"sources":["search.ts"],"names":[],"mappings":"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","file":"search.js","sourcesContent":["const puppeteer = require('puppeteer');\n\nimport engines from './engines';\n\nconst document: any = {};\n\nclass PagePool {\n  size = engines.length * 2\n\n  freePages = []\n\n  reservations = []\n\n  totalPages = 0\n\n  browserPromise\n\n  constructor(browserPromise) {\n    this.browserPromise = browserPromise;\n  }\n\n  async getPage() {\n    const browser = await this.browserPromise;\n\n    let page = this.freePages.pop();\n\n    if (page === undefined) {\n      if (this.totalPages < this.size) {\n        this.totalPages++;\n        page = await browser.newPage();\n      }\n      else {\n        page = await this.waitForPage();\n      }\n    }\n\n    return {\n      page,\n      release: (page => {\n        const next = this.reservations.pop();\n\n        if (next === undefined)\n          this.freePages.push(page);\n        else\n          next(page);\n\n      }).bind(this, page)\n    };\n  }\n\n  waitForPage() {\n    return new Promise((resolve, reject) => this.reservations.push(resolve));\n  }\n}\n\nconst pagePool = new PagePool(puppeteer.launch());\n\nexport default async (query = 'test', partialResults) => {\n  const start = new Date().getTime(),\n        results = await Promise.all(search(query, pagePool, partialResults)),\n        end = new Date().getTime(),\n        urls = results.reduce((urls, {name, results}, i) => {\n          return results.reduce((urls, {url}, i) => {\n            (urls[url] = urls[url] || []).push([name, i]);\n            return urls;\n          }, urls);\n        }, {});\n\n  return {urls, results, start, end};\n};\n\nfunction search(query, pagePool, partialResults) {\n  return engines.map(async ({name, queryUrl, evaluator}) => {\n    const {page, release} = await pagePool.getPage();\n\n    // page.on('console', ({args}) => console.log(`${name} console: ${args.join(' ')}`));\n    const start = new Date().getTime();\n    await page.goto(`${queryUrl}${encodeURI(query)}`);\n    const end = new Date().getTime();\n\n    const results = await page.evaluate(evaluator);\n\n    partialResults({name, results, start, end});\n\n    release();\n\n    return {name, results, start, end};\n  });\n}\n\nconst groupBy = (list, selector, transform = a => a, groups = {}) => list.reduce((groups, item) => {\n  const value = selector(item);\n  (groups[value] = groups[value] || []).push(transform(item));\n  return groups;\n})\n\n// function groupBy(list, property) {\n//   return list.reduce((groups, item) => {\n//     const value = selector(item);\n//     (groups[value] = groups[value] || []).push(transform(item))\n//   });\n//   return list.reduce((groups, item) => {\n//     (groups[property] = groups[property] || []).push(item);\n//     return groups;\n//   }, {});\n// }"]}